# Box conv
https://papers.nips.cc/paper/7859-deep-neural-networks-with-box-convolutions

## Введение

### Проблема:
нужно ловить spatially-distant зависимости, а в сверточных сетях нет feed-back связей (другими словами, маленький receptive field).

### Возможные решения:
* Stack more layers -- медленно
* Spatial downsampling early in the pipeline -- потеря информации (особенно spatial. особенно в seg, когда делаешь upsampling проблемы с этим. skip-connections не спасают)
* Use spatially-large filters, но выходит много параметров O(n^2) -- медленно и оверфит
* Dilated Conv -- как предыдущий, но параметров мало (многие используют, особенно в semantic seg)
* Ещё можно сделать non-local-conv, что на самом деле Conditional Random Fields (CRF)

Предлагается новый слой. Применяет box-average filters в стиле conv-слоя. Т.е. есть скользящее окно размера ???, в котором учится dims и offsets прямоугольника в котором считается среднее:
* большой фильтр;
* мало параметров;
* очень быстро считается, благодаря кумулятивным суммам;
* эффективно учитывает spatial info over large spatial extents.

## История
Ещё в 2000 box-filtering был мейнстримом, начиная с Viola-Jones face-detection. Потом pedestrian-detection. Всё считалось очень быстро, благодаря integral image trick.

В DL бывали работы в obj-det, sem-seg, image-retrieval, но применялся box-filt только в конце пайплайна и без int-image-trick. В одной работе применялся int-img-trick, но там были предефайнд размеры прямоугольников и ветка предсказывала только objectiveness-score.

## Сам метод
Идея простая. Сложность реализации: обучаемые координаты и отступы. Обучаемые, значит непрерывные. Делается относительно просто.

Forward pass: вход HxWxN к каждому слою HxW применяется M разных box-conv преобразований и получается HxWxNM выход. Слой при этом имеет 4NM обучаемых параметра.

## Детали реализации
Параметры могут быть не любыми. При обучении проверяется, чтобы ширина и длина бокса были минимум `\eps=1` пиксель: `x_max - x_min > eps`, `y_max - y_min > eps`. Сделано с помощью _projective sgd_: когда нарушается ограничение, x_min и x_max раздвигаются на eps, сохраняя середину. При выходе за границу окна значения клипаются.

Кроме этого, есть l2-reg на норму параметров. Стабилизирует сходимость и не дает боксам всем уйти за границу.

Инициализация: сначала хочется diverse фильтры. Поэтому боксы выбираются рандомно и независимо. Сначала сэмплится центр бокса равномерно из окна, а потом равномерно сэмплится ширина и длина.

## Быстрая реализация via integral-images



## Результаты
* Метрики выше, производительность выше, параметров меньше.
* Прямоугольники получились симметричные по горизонтали -- скорее всего можно использовать на один параметр меньше (-сдвиг по горизонтали).
* Часть боксов схлопнулись до минимального размера и их можно удалить из модели без потери качества.
* Важность боксов -- смотрели коэффициент в 1x1 conv, следующим за бокс-слоем. Важны большие и очень большие боксы. S_бокса ~ 100-1000. Т.е. условно 10x10-30x30.
